<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMessage ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <svg viewBox="0 0 24 24">
            <path fill="white" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </div>
    
    <div class="content">
        <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ -->
        <div class="settings-card">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 8px; fill: #667eea;">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
            </h3>
            <div class="avatar-section">
                <div class="avatar" id="avatar" onclick="document.getElementById('fileInput').click()">
                    <span id="avatarLetter">?</span>
                    <img id="avatarImg" src="" style="display: none;">
                </div>
                <div class="avatar-upload">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="uploadAvatar()">
                    <label for="fileInput" class="file-upload-label">
                        <svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align: middle; margin-right: 5px; fill: white;">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
                    </label>
                    <button onclick="removeAvatar()">
                        <svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align: middle; margin-right: 5px; fill: white;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å -->
        <div class="settings-card">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 8px; fill: #667eea;">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
            </h3>
            
            <div class="settings-item">
                <span class="settings-label">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    –°–∫—Ä—ã—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
                </span>
                <label class="switch">
                    <input type="checkbox" id="hideAvatar" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="settings-item">
                <span class="settings-label">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8m0-2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                    </svg>
                    –°–∫—Ä—ã—Ç—å –∏–º—è
                </span>
                <label class="switch">
                    <input type="checkbox" id="hideName" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="settings-item">
                <span class="settings-label">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                    –°–∫—Ä—ã—Ç—å email
                </span>
                <label class="switch">
                    <input type="checkbox" id="hideEmail" onchange="toggleHideEmail()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div id="emailWarning" class="warning" style="display: none;">
                ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ï—Å–ª–∏ —Å–∫—Ä—ã—Ç—å email, –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É!
            </div>
        </div>

        <!-- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ -->
        <div class="settings-card">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 8px; fill: #667eea;">
                    <path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/>
                </svg>
                –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
            </h3>
            
            <div class="settings-item">
                <span class="settings-label">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
                    </svg>
                    –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
                </span>
                <label class="switch">
                    <input type="checkbox" id="darkTheme" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="settings-card">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 8px; fill: #667eea;">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="userName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 12px;">
                <button onclick="updateName()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ -->
        <div class="settings-card">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 8px; fill: #667eea;">
                    <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
                </svg>
                –•—Ä–∞–Ω–∏–ª–∏—â–µ
            </h3>
            <div class="cache-info" id="storageInfo">
                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
            <p style="font-size: 12px; color: #999; margin: 10px 0;">
                üìÅ –í—Å–µ —Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã.
            </p>
        </div>

        <!-- –í—ã—Ö–æ–¥ -->
        <button class="logout-btn" onclick="logout()">
            <svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align: middle; margin-right: 5px; fill: white;">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        </button>
    </div>

    <div class="navbar">
        <a href="index.html">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>–õ–µ–Ω—Ç–∞</span>
        </a>
        <a href="chats.html">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2z"/>
            </svg>
            <span>–ß–∞—Ç—ã</span>
        </a>
        <a href="notifications.html">
            <svg viewBox="0 0 24 24">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            <span>–£–≤–µ–¥–æ–º.</span>
        </a>
        <a href="profile.html">
            <svg viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
        <a href="settings.html" class="active">
            <svg viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94 0 .31.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </a>
    </div>

    <script>
        async function loadSettings() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location = 'auth.html';
                return;
            }

            try {
                const res = await fetch('/profile', {
                    headers: { 'Authorization': token }
                });

                if (res.ok) {
                    const data = await res.json();
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
                    if (data.settings && data.settings.theme) {
                        document.body.className = data.settings.theme;
                        document.getElementById('darkTheme').checked = data.settings.theme === 'dark';
                    }
                    
                    // –ò–º—è
                    document.getElementById('userName').value = data.name || '';
                    
                    // –ê–≤–∞—Ç–∞—Ä
                    const letter = (data.name || data.email).charAt(0).toUpperCase();
                    document.getElementById('avatarLetter').textContent = letter;
                    
                    if (data.avatar) {
                        showAvatar(data.avatar);
                    }
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (data.settings) {
                        document.getElementById('hideAvatar').checked = data.settings.hideAvatar || false;
                        document.getElementById('hideName').checked = data.settings.hideName || false;
                        document.getElementById('hideEmail').checked = data.settings.hideEmail || false;
                        
                        if (data.settings.hideEmail) {
                            document.getElementById('emailWarning').style.display = 'block';
                        }
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
            
            loadStorageInfo();
        }

        async function loadStorageInfo() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch('/storage/info', {
                    headers: { 'Authorization': token }
                });
                
                if (res.ok) {
                    const info = await res.json();
                    
                    const totalSizeMB = (info.uploadsSize / (1024 * 1024)).toFixed(2);
                    
                    document.getElementById('storageInfo').innerHTML = `
                        <div class="cache-item">
                            <div class="cache-value">${info.uploadsCount}</div>
                            <div class="cache-label">–§–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</div>
                        </div>
                        <div class="cache-item">
                            <div class="cache-value">${totalSizeMB} –ú–ë</div>
                            <div class="cache-label">–ó–∞–Ω—è—Ç–æ –º–µ—Å—Ç–∞</div>
                        </div>
                        <div class="cache-item">
                            <div class="cache-value">${info.usersCount}</div>
                            <div class="cache-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="cache-item">
                            <div class="cache-value">${info.groupsCount || 0}</div>
                            <div class="cache-label">–ì—Ä—É–ø–ø</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
            }
        }

        function showAvatar(url) {
            const img = document.getElementById('avatarImg');
            const letter = document.getElementById('avatarLetter');
            if (url) {
                img.src = url;
                img.style.display = 'block';
                letter.style.display = 'none';
            } else {
                img.style.display = 'none';
                letter.style.display = 'block';
            }
        }

        async function uploadAvatar() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const avatarUrl = e.target.result;
                showAvatar(avatarUrl);
                
                const token = localStorage.getItem('token');
                try {
                    await fetch('/profile/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        },
                        body: JSON.stringify({ avatar: avatarUrl })
                    });
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞');
                }
            };
            reader.readAsDataURL(file);
        }

        async function removeAvatar() {
            showAvatar('');
            document.getElementById('fileInput').value = '';
            
            const token = localStorage.getItem('token');
            try {
                await fetch('/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ avatar: '' })
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞');
            }
        }

        async function updateName() {
            const name = document.getElementById('userName').value;
            if (!name) return;

            const token = localStorage.getItem('token');
            try {
                await fetch('/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ name })
                });
                alert('–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏');
            }
        }

        async function toggleHideEmail() {
            const checked = document.getElementById('hideEmail').checked;
            document.getElementById('emailWarning').style.display = checked ? 'block' : 'none';
            await saveSettings();
        }

        async function toggleTheme() {
            const isDark = document.getElementById('darkTheme').checked;
            document.body.className = isDark ? 'dark' : 'light';
            await saveSettings({ theme: isDark ? 'dark' : 'light' });
        }

        async function saveSettings(extra = {}) {
            const token = localStorage.getItem('token');
            
            const settings = {
                hideAvatar: document.getElementById('hideAvatar').checked,
                hideName: document.getElementById('hideName').checked,
                hideEmail: document.getElementById('hideEmail').checked,
                theme: document.getElementById('darkTheme').checked ? 'dark' : 'light',
                ...extra
            };

            try {
                await fetch('/settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': token 
                    },
                    body: JSON.stringify(settings)
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location = 'auth.html';
        }

        loadSettings();

        if (!localStorage.getItem('token')) {
            window.location = 'auth.html';
        }
    </script>
</body>
</html>
